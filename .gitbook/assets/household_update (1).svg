<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1559px" preserveAspectRatio="none" style="width:1986px;height:1559px;background:#FFFFFF;" version="1.1" viewBox="0 0 1986 1559" width="1986px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="1157.25" style="stroke:#696969;stroke-width:1.0;" width="10" x="621.5" y="98.4297"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="544.0234"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="926.4844"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1043.0156"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1109.1484"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1196.5469"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="246.5273"/><rect fill="#FFFFFF" height="83.2656" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="681.6875"/><rect fill="#FFFFFF" height="170.6641" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="1167.4141"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1404.5" y="1308.9453"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1540.5" y="1338.0781"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1662.5" y="310.3594"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1662.5" y="734.9531"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1779" y="1367.2109"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="369.4922"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="602.2891"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="794.0859"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="984.75"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="1426.3438"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1971.5" x="9" y="155.5625"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="272.0938"/><rect fill="none" height="368.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1917.5" x="63" y="505.7578"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="696.6875"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1428" x="542.5" y="888.2188"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="1270.6797"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="317" x2="317" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="626.5" x2="626.5" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1124" x2="1124" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1213" x2="1213" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1409" x2="1409" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1545" x2="1545" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1667" x2="1667" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1784" x2="1784" y1="67.2969" y2="1481.3438"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1923.5" x2="1923.5" y1="67.2969" y2="1481.3438"/><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="57" x="289" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="296" y="55.9951">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="57" x="289" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="296" y="1500.3389">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="552.5" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="559.5" y="55.9951">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="552.5" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="559.5" y="1500.3389">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="97" x="1076" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="1083" y="55.9951">RedisCache</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="97" x="1076" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="1083" y="1500.3389">RedisCache</text><path d="M1188,41 L1239,41 C1244,41 1244,54.1484 1244,54.1484 C1244,54.1484 1244,67.2969 1239,67.2969 L1188,67.2969 C1183,67.2969 1183,54.1484 1183,54.1484 C1183,54.1484 1183,41 1188,41 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1239,41 C1234,41 1234,54.1484 1234,54.1484 C1234,67.2969 1239,67.2969 1239,67.2969 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="1188" y="58.9951">Kafka</text><path d="M1188,1480.3438 L1239,1480.3438 C1244,1480.3438 1244,1493.4922 1244,1493.4922 C1244,1493.4922 1244,1506.6406 1239,1506.6406 L1188,1506.6406 C1183,1506.6406 1183,1493.4922 1183,1493.4922 C1183,1493.4922 1183,1480.3438 1188,1480.3438 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1239,1480.3438 C1234,1480.3438 1234,1493.4922 1234,1493.4922 C1234,1506.6406 1239,1506.6406 1239,1506.6406 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="1188" y="1498.3389">Kafka</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="131" x="1344" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117" x="1351" y="55.9951">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="131" x="1344" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117" x="1351" y="1500.3389">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1485" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1492" y="55.9951">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1485" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1492" y="1500.3389">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1616" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1623" y="55.9951">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1616" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1623" y="1500.3389">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1729" y="36"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1736" y="55.9951">ElasticSearch</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1729" y="1480.3438"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1736" y="1500.3389">ElasticSearch</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1886.5" y="63.9951">Database</text><path d="M1905.5,15 C1905.5,5 1923.5,5 1923.5,5 C1923.5,5 1941.5,5 1941.5,15 L1941.5,41 C1941.5,51 1923.5,51 1923.5,51 C1923.5,51 1905.5,51 1905.5,41 L1905.5,15 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1905.5,15 C1905.5,25 1923.5,25 1923.5,25 C1923.5,25 1941.5,25 1941.5,15 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1886.5" y="1493.3389">Database</text><path d="M1905.5,1506.6406 C1905.5,1496.6406 1923.5,1496.6406 1923.5,1496.6406 C1923.5,1496.6406 1941.5,1496.6406 1941.5,1506.6406 L1941.5,1532.6406 C1941.5,1542.6406 1923.5,1542.6406 1923.5,1542.6406 C1923.5,1542.6406 1905.5,1542.6406 1905.5,1532.6406 L1905.5,1506.6406 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1905.5,1506.6406 C1905.5,1516.6406 1923.5,1516.6406 1923.5,1516.6406 C1923.5,1516.6406 1941.5,1516.6406 1941.5,1506.6406 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><rect fill="#FFFFFF" height="1157.25" style="stroke:#696969;stroke-width:1.0;" width="10" x="621.5" y="98.4297"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="544.0234"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="926.4844"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1043.0156"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1109.1484"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1119.5" y="1196.5469"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="246.5273"/><rect fill="#FFFFFF" height="83.2656" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="681.6875"/><rect fill="#FFFFFF" height="170.6641" style="stroke:#696969;stroke-width:1.0;" width="10" x="1208.5" y="1167.4141"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1404.5" y="1308.9453"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1540.5" y="1338.0781"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1662.5" y="310.3594"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1662.5" y="734.9531"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1779" y="1367.2109"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="369.4922"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="602.2891"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="794.0859"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="984.75"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1918.5" y="1426.3438"/><polygon fill="#454645" points="609.5,94.4297,619.5,98.4297,609.5,102.4297,613.5,98.4297" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="317.5" x2="615.5" y1="98.4297" y2="98.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="324.5" y="93.3638">/household/v1/_update</text><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="673.5" y1="127.5625" y2="127.5625"/><line style="stroke:#454645;stroke-width:1.0;" x1="673.5" x2="673.5" y1="127.5625" y2="140.5625"/><line style="stroke:#454645;stroke-width:1.0;" x1="632.5" x2="673.5" y1="140.5625" y2="140.5625"/><polygon fill="#454645" points="642.5,136.5625,632.5,140.5625,642.5,144.5625,638.5,140.5625" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="638.5" y="122.4966">Validate request body</text><path d="M12.5,155.5625 L75,155.5625 L75,162.6953 L65,172.6953 L9,172.6953 L9,159.0625 A3.5,3.5 0 0 1 12.5,155.5625 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1971.5" x="9" y="155.5625"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="24" y="168.6294">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="167" x="90" y="167.7729">[request validation fails]</text><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="673.5" y1="193.8281" y2="193.8281"/><line style="stroke:#454645;stroke-width:1.0;" x1="673.5" x2="673.5" y1="193.8281" y2="206.8281"/><line style="stroke:#454645;stroke-width:1.0;" x1="632.5" x2="673.5" y1="206.8281" y2="206.8281"/><polygon fill="#454645" points="642.5,202.8281,632.5,206.8281,642.5,210.8281,638.5,206.8281" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="638.5" y="188.7622">Request validation failed</text><polygon fill="#454645" points="1196.5,242.5273,1206.5,246.5273,1196.5,250.5273,1200.5,246.5273" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1202.5" y1="246.5273" y2="246.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="638.5" y="241.4614">Household Data /error_topic</text><path d="M281,223.3281 L281,256.3281 A3.5,3.5 0 0 0 284.5,259.8281 L612.5,259.8281 A3.5,3.5 0 0 0 616,256.3281 L616,229.8281 L606,219.8281 L284.5,219.8281 A3.5,3.5 0 0 0 281,223.3281 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M606,219.8281 L606,228.0781 A1.75,1.75 0 0 0 607.75,229.8281 L616,229.8281 L606,219.8281 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="287" y="236.895">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="287" y="252.0278">and require manual intervention</text><path d="M1176.5,272.0938 L1260,272.0938 L1260,279.2266 L1250,289.2266 L1173,289.2266 L1173,275.5938 A3.5,3.5 0 0 1 1176.5,272.0938 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="272.0938"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1188" y="285.1606">async</text><polygon fill="#454645" points="1229.5,306.3594,1219.5,310.3594,1229.5,314.3594,1225.5,310.3594" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1223.5" x2="1661.5" y1="310.3594" y2="310.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="1235.5" y="305.2935">Consume Household Data</text><polygon fill="#454645" points="1906.5,365.4922,1916.5,369.4922,1906.5,373.4922,1910.5,369.4922" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1672.5" x2="1912.5" y1="369.4922" y2="369.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1679.5" y="364.4263">Persist Household Data /error_table</text><polygon fill="#454645" points="328.5,434.625,318.5,438.625,328.5,442.625,324.5,438.625" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="322.5" x2="620.5" y1="438.625" y2="438.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="334.5" y="433.5591">HttpStatus: 400 with appropriate error code</text><path d="M19,422.9922 L19,440.9922 A3.5,3.5 0 0 0 22.5,444.4922 L308.5,444.4922 A3.5,3.5 0 0 0 312,440.9922 L312,429.4922 L302,419.4922 L22.5,419.4922 A3.5,3.5 0 0 0 19,422.9922 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M302,419.4922 L302,427.7422 A1.75,1.75 0 0 0 303.75,429.4922 L312,429.4922 L302,419.4922 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="25" y="436.5591">Error Code: REQUEST_VALIDATION_FAILED</text><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="673.5" y1="477.7578" y2="477.7578"/><line style="stroke:#454645;stroke-width:1.0;" x1="673.5" x2="673.5" y1="477.7578" y2="490.7578"/><line style="stroke:#454645;stroke-width:1.0;" x1="632.5" x2="673.5" y1="490.7578" y2="490.7578"/><polygon fill="#454645" points="642.5,486.7578,632.5,490.7578,642.5,494.7578,638.5,490.7578" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="638.5" y="472.6919">Request validation successful</text><path d="M66.5,505.7578 L129,505.7578 L129,512.8906 L119,522.8906 L63,522.8906 L63,509.2578 A3.5,3.5 0 0 1 66.5,505.7578 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="368.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1917.5" x="63" y="505.7578"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="78" y="518.8247">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="145" x="144" y="517.9683">[record doesn't exist]</text><polygon fill="#454645" points="1107.5,540.0234,1117.5,544.0234,1107.5,548.0234,1111.5,544.0234" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1113.5" y1="544.0234" y2="544.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="638.5" y="538.9575">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="642.5,569.1563,632.5,573.1563,642.5,577.1563,638.5,573.1563" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="636.5" x2="1123.5" y1="573.1563" y2="573.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="648.5" y="568.0903">0 rows</text><polygon fill="#454645" points="1906.5,598.2891,1916.5,602.2891,1906.5,606.2891,1910.5,602.2891" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1912.5" y1="602.2891" y2="602.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="638.5" y="597.2231">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="642.5,637.9883,632.5,641.9883,642.5,645.9883,638.5,641.9883" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="636.5" x2="1922.5" y1="641.9883" y2="641.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="648.5" y="636.9224">0 row</text><path d="M281,618.7891 L281,651.7891 A3.5,3.5 0 0 0 284.5,655.2891 L612.5,655.2891 A3.5,3.5 0 0 0 616,651.7891 L616,625.2891 L606,615.2891 L284.5,615.2891 A3.5,3.5 0 0 0 281,618.7891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M606,615.2891 L606,623.5391 A1.75,1.75 0 0 0 607.75,625.2891 L616,625.2891 L606,615.2891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="287" y="632.356">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="287" y="647.4888">and require manual intervention</text><polygon fill="#454645" points="1196.5,677.6875,1206.5,681.6875,1196.5,685.6875,1200.5,681.6875" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1202.5" y1="681.6875" y2="681.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="638.5" y="676.6216">Individual Data /error_topic</text><path d="M1176.5,696.6875 L1260,696.6875 L1260,703.8203 L1250,713.8203 L1173,713.8203 L1173,700.1875 A3.5,3.5 0 0 1 1176.5,696.6875 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="696.6875"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1188" y="709.7544">async</text><polygon fill="#454645" points="1229.5,730.9531,1219.5,734.9531,1229.5,738.9531,1225.5,734.9531" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1223.5" x2="1661.5" y1="734.9531" y2="734.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="1235.5" y="729.8872">Consume Individual Data</text><polygon fill="#454645" points="1906.5,790.0859,1916.5,794.0859,1906.5,798.0859,1910.5,794.0859" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1672.5" x2="1912.5" y1="794.0859" y2="794.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1679.5" y="789.02">Persist Individual Data /error_table</text><polygon fill="#454645" points="328.5,859.2188,318.5,863.2188,328.5,867.2188,324.5,863.2188" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="322.5" x2="620.5" y1="863.2188" y2="863.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="334.5" y="858.1528">HttpStatus: 400 with appropriate error code</text><path d="M73,847.5859 L73,865.5859 A3.5,3.5 0 0 0 76.5,869.0859 L308.5,869.0859 A3.5,3.5 0 0 0 312,865.5859 L312,854.0859 L302,844.0859 L76.5,844.0859 A3.5,3.5 0 0 0 73,847.5859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M302,844.0859 L302,852.3359 A1.75,1.75 0 0 0 303.75,854.0859 L312,854.0859 L302,844.0859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="79" y="861.1528">Error Code: RECORD_NOT_FOUND</text><path d="M546,888.2188 L608.5,888.2188 L608.5,895.3516 L598.5,905.3516 L542.5,905.3516 L542.5,891.7188 A3.5,3.5 0 0 1 546,888.2188 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1428" x="542.5" y="888.2188"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="557.5" y="901.2856">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="210" x="623.5" y="900.4292">[record doesn't exists in cache]</text><polygon fill="#454645" points="1107.5,922.4844,1117.5,926.4844,1107.5,930.4844,1111.5,926.4844" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1113.5" y1="926.4844" y2="926.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="638.5" y="921.4185">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="642.5,951.6172,632.5,955.6172,642.5,959.6172,638.5,955.6172" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="636.5" x2="1123.5" y1="955.6172" y2="955.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="648.5" y="950.5513">0 rows</text><polygon fill="#454645" points="1906.5,980.75,1916.5,984.75,1906.5,988.75,1910.5,984.75" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1912.5" y1="984.75" y2="984.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="638.5" y="979.6841">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="642.5,1009.8828,632.5,1013.8828,642.5,1017.8828,638.5,1013.8828" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="636.5" x2="1922.5" y1="1013.8828" y2="1013.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="648.5" y="1008.8169">1 row</text><polygon fill="#454645" points="1107.5,1039.0156,1117.5,1043.0156,1107.5,1047.0156,1111.5,1043.0156" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1113.5" y1="1043.0156" y2="1043.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="638.5" y="1037.9497">1 record</text><polygon fill="#454645" points="1107.5,1105.1484,1117.5,1109.1484,1107.5,1113.1484,1111.5,1109.1484" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1113.5" y1="1109.1484" y2="1109.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="638.5" y="1104.0825">Fetch the existing record</text><polygon fill="#454645" points="642.5,1134.2813,632.5,1138.2813,642.5,1142.2813,638.5,1138.2813" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="636.5" x2="1123.5" y1="1138.2813" y2="1138.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="648.5" y="1133.2153">1 row</text><polygon fill="#454645" points="1196.5,1163.4141,1206.5,1167.4141,1196.5,1171.4141,1200.5,1167.4141" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1202.5" y1="1167.4141" y2="1167.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="638.5" y="1162.3481">Household Data /update_topic</text><polygon fill="#454645" points="1107.5,1192.5469,1117.5,1196.5469,1107.5,1200.5469,1111.5,1196.5469" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="631.5" x2="1113.5" y1="1196.5469" y2="1196.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="469" x="638.5" y="1191.481">Update new record in cache against clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="328.5,1251.6797,318.5,1255.6797,328.5,1259.6797,324.5,1255.6797" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="322.5" x2="625.5" y1="1255.6797" y2="1255.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="334.5" y="1250.6138">HttpStatus: 202 ACCEPTED</text><path d="M1176.5,1270.6797 L1260,1270.6797 L1260,1277.8125 L1250,1287.8125 L1173,1287.8125 L1173,1274.1797 A3.5,3.5 0 0 1 1176.5,1270.6797 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="797.5" x="1173" y="1270.6797"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1188" y="1283.7466">async</text><polygon fill="#454645" points="1229.5,1304.9453,1219.5,1308.9453,1229.5,1312.9453,1225.5,1308.9453" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1223.5" x2="1403.5" y1="1308.9453" y2="1308.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="1235.5" y="1303.8794">Consume Household Data</text><polygon fill="#454645" points="1224.5,1334.0781,1214.5,1338.0781,1224.5,1342.0781,1220.5,1338.0781" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1218.5" x2="1539.5" y1="1338.0781" y2="1338.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="1230.5" y="1333.0122">Consume Household Data</text><polygon fill="#454645" points="1767,1363.2109,1777,1367.2109,1767,1371.2109,1771,1367.2109" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1550.5" x2="1773" y1="1367.2109" y2="1367.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1557.5" y="1362.145">Store Household Data</text><polygon fill="#454645" points="1906.5,1422.3438,1916.5,1426.3438,1906.5,1430.3438,1910.5,1426.3438" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1414.5" x2="1912.5" y1="1426.3438" y2="1426.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1421.5" y="1421.2778">Update Household Data</text><!--MD5=[183978c3dead326684e5eec771a08929]
@startuml
!theme vibrant
participant Client as c
participant HouseholdRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    s -> k: Individual Data /error_topic
    activate k
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
s -> k: Household Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    deactivate k
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Household Data
    activate db
    deactivate db
    deactivate prs
end
@enduml

@startuml
skinparam BackgroundColor FFFFFF
skinparam shadowing false
skinparam RoundCorner 7
skinparam ArrowColor 454645
skinparam FontColor 454645
skinparam SequenceLifeLineBorderColor 696969
skinparam SequenceGroupHeaderFontColor 454645
skinparam SequenceGroupFontColor 696969
skinparam SequenceGroupBorderColor 696969
skinparam SequenceGroupBorderThickness 1

skinparam sequenceDivider {
    BorderColor 454645
    BorderThickness 1
    FontColor 454645
}

skinparam participant {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFFFFF
    BorderThickness 1.5
}

skinparam database {
    BackgroundColor 00FFFF
    BorderColor 454645
    FontColor 454645
}

skinparam entity {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam note {
    BackgroundColor 7FFFD4
    BorderColor 454645
    FontColor 454645
    BorderThickness 1.5
}

skinparam actor {
    BackgroundColor 454645
    BorderColor 454645
    FontColor 454645
}

skinparam boundary {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam control {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam collections {
    BackgroundColor FF5F42
    BorderColor 454645
    FontColor 454645
}

skinparam queue {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFF
    BorderThickness 1.5
}
participant Client as c
participant HouseholdRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    s -> k: Individual Data /error_topic
    activate k
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
s -> k: Household Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    deactivate k
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Household Data
    activate db
    deactivate db
    deactivate prs
end
@enduml

PlantUML version 1.2022.13beta8(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>