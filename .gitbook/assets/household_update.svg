<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2010px" preserveAspectRatio="none" style="width:2004px;height:2010px;background:#FFFFFF;" version="1.1" viewBox="0 0 2004 2010" width="2004px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="26.2969" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="168" x="919.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="158" x="924.5" y="27.9951">Household - Update</text><rect fill="#FFFFFF" height="1570.5781" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="581.3203"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="963.7813"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1080.3125"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1146.4453"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1647.1719"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="283.8242"/><rect fill="#FFFFFF" height="83.2656" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="718.9844"/><rect fill="#FFFFFF" height="170.6641" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="1618.0391"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1419.5" y="1759.5703"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1554" y="1788.7031"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="772.25"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="1366.375"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1792.5" y="1817.8359"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="406.7891"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="639.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="831.3828"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1022.0469"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1425.5078"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1876.9688"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1989" x="9" y="192.8594"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="309.3906"/><rect fill="none" height="368.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1933" x="65" y="543.0547"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="733.9844"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1439.5" x="548.5" y="925.5156"/><rect fill="none" height="315.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1885" x="113" y="1190.5781"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="1328.1094"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="1721.3047"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="321" x2="321" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="632.5" x2="632.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1137.5" x2="1137.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1226.5" x2="1226.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1424.5" x2="1424.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1558.5" x2="1558.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1680.5" x2="1680.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1797.5" x2="1797.5" y1="104.5938" y2="1931.9688"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1941" x2="1941" y1="104.5938" y2="1931.9688"/><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="93.292">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="1950.9639">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="558.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="565.5" y="93.292">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="558.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="565.5" y="1950.9639">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1088.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1095.5" y="93.292">RedisCache</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1088.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1095.5" y="1950.9639">RedisCache</text><path d="M1201.5,78.2969 L1251.5,78.2969 C1256.5,78.2969 1256.5,91.4453 1256.5,91.4453 C1256.5,91.4453 1256.5,104.5938 1251.5,104.5938 L1201.5,104.5938 C1196.5,104.5938 1196.5,91.4453 1196.5,91.4453 C1196.5,91.4453 1196.5,78.2969 1201.5,78.2969 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1251.5,78.2969 C1246.5,78.2969 1246.5,91.4453 1246.5,91.4453 C1246.5,104.5938 1251.5,104.5938 1251.5,104.5938 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1201.5" y="96.292">Kafka</text><path d="M1201.5,1930.9688 L1251.5,1930.9688 C1256.5,1930.9688 1256.5,1944.1172 1256.5,1944.1172 C1256.5,1944.1172 1256.5,1957.2656 1251.5,1957.2656 L1201.5,1957.2656 C1196.5,1957.2656 1196.5,1944.1172 1196.5,1944.1172 C1196.5,1944.1172 1196.5,1930.9688 1201.5,1930.9688 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1251.5,1930.9688 C1246.5,1930.9688 1246.5,1944.1172 1246.5,1944.1172 C1246.5,1957.2656 1251.5,1957.2656 1251.5,1957.2656 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1201.5" y="1948.9639">Kafka</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1360.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1367.5" y="93.292">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1360.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1367.5" y="1950.9639">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1498.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1505.5" y="93.292">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1498.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1505.5" y="1950.9639">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1629.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1636.5" y="93.292">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1629.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1636.5" y="1950.9639">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1742.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1749.5" y="93.292">ElasticSearch</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1742.5" y="1930.9688"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1749.5" y="1950.9639">ElasticSearch</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1904" y="101.292">Database</text><path d="M1923,52.2969 C1923,42.2969 1941,42.2969 1941,42.2969 C1941,42.2969 1959,42.2969 1959,52.2969 L1959,78.2969 C1959,88.2969 1941,88.2969 1941,88.2969 C1941,88.2969 1923,88.2969 1923,78.2969 L1923,52.2969 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1923,52.2969 C1923,62.2969 1941,62.2969 1941,62.2969 C1941,62.2969 1959,62.2969 1959,52.2969 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1904" y="1943.9639">Database</text><path d="M1923,1957.2656 C1923,1947.2656 1941,1947.2656 1941,1947.2656 C1941,1947.2656 1959,1947.2656 1959,1957.2656 L1959,1983.2656 C1959,1993.2656 1941,1993.2656 1941,1993.2656 C1941,1993.2656 1923,1993.2656 1923,1983.2656 L1923,1957.2656 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1923,1957.2656 C1923,1967.2656 1941,1967.2656 1941,1967.2656 C1941,1967.2656 1959,1967.2656 1959,1957.2656 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><rect fill="#FFFFFF" height="1570.5781" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="581.3203"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="963.7813"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1080.3125"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1146.4453"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1647.1719"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="283.8242"/><rect fill="#FFFFFF" height="83.2656" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="718.9844"/><rect fill="#FFFFFF" height="170.6641" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="1618.0391"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1419.5" y="1759.5703"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1554" y="1788.7031"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="772.25"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1676" y="1366.375"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1792.5" y="1817.8359"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="406.7891"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="639.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="831.3828"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1022.0469"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1425.5078"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1936" y="1876.9688"/><polygon fill="#454645" points="615.5,131.7266,625.5,135.7266,615.5,139.7266,619.5,135.7266" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="321.5" x2="621.5" y1="135.7266" y2="135.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="328.5" y="130.6606">/household/v1/_update</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="164.8594" y2="164.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="164.8594" y2="177.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="177.8594" y2="177.8594"/><polygon fill="#454645" points="648.5,173.8594,638.5,177.8594,648.5,181.8594,644.5,177.8594" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="644.5" y="159.7935">Validate request body</text><path d="M12.5,192.8594 L73,192.8594 L73,199.9922 L63,209.9922 L9,209.9922 L9,196.3594 A3.5,3.5 0 0 1 12.5,192.8594 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1989" x="9" y="192.8594"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="24" y="205.9263">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88" y="205.0698">[request validation fails]</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="231.125" y2="231.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="231.125" y2="244.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="244.125" y2="244.125"/><polygon fill="#454645" points="648.5,240.125,638.5,244.125,648.5,248.125,644.5,244.125" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="644.5" y="226.0591">Request validation failed</text><polygon fill="#454645" points="1209.5,279.8242,1219.5,283.8242,1209.5,287.8242,1213.5,283.8242" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1215.5" y1="283.8242" y2="283.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="644.5" y="278.7583">Household Data /error_topic</text><path d="M280,260.625 L280,293.625 A3.5,3.5 0 0 0 283.5,297.125 L618.5,297.125 A3.5,3.5 0 0 0 622,293.625 L622,267.125 L612,257.125 L283.5,257.125 A3.5,3.5 0 0 0 280,260.625 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M612,257.125 L612,265.375 A1.75,1.75 0 0 0 613.75,267.125 L622,267.125 L612,257.125 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="286" y="274.1919">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="286" y="289.3247">and require manual intervention</text><path d="M1190,309.3906 L1273.5,309.3906 L1273.5,316.5234 L1263.5,326.5234 L1186.5,326.5234 L1186.5,312.8906 A3.5,3.5 0 0 1 1190,309.3906 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="309.3906"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="322.4575">async</text><polygon fill="#454645" points="1242.5,343.6563,1232.5,347.6563,1242.5,351.6563,1238.5,347.6563" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1675" y1="347.6563" y2="347.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1248.5" y="342.5903">Consume Household Data</text><polygon fill="#454645" points="1924,402.7891,1934,406.7891,1924,410.7891,1928,406.7891" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1686" x2="1930" y1="406.7891" y2="406.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="1693" y="401.7231">Persist Household Data /error_table</text><polygon fill="#454645" points="332.5,471.9219,322.5,475.9219,332.5,479.9219,328.5,475.9219" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="475.9219" y2="475.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="470.856">HttpStatus: 400 with appropriate error code</text><path d="M19,460.2891 L19,478.2891 A3.5,3.5 0 0 0 22.5,481.7891 L312.5,481.7891 A3.5,3.5 0 0 0 316,478.2891 L316,466.7891 L306,456.7891 L22.5,456.7891 A3.5,3.5 0 0 0 19,460.2891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,456.7891 L306,465.0391 A1.75,1.75 0 0 0 307.75,466.7891 L316,466.7891 L306,456.7891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="276" x="25" y="473.856">Error Code: REQUEST_VALIDATION_FAILED</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="515.0547" y2="515.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="515.0547" y2="528.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="528.0547" y2="528.0547"/><polygon fill="#454645" points="648.5,524.0547,638.5,528.0547,648.5,532.0547,644.5,528.0547" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="644.5" y="509.9888">Request validation successful</text><path d="M68.5,543.0547 L129,543.0547 L129,550.1875 L119,560.1875 L65,560.1875 L65,546.5547 A3.5,3.5 0 0 1 68.5,543.0547 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="368.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1933" x="65" y="543.0547"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="80" y="556.1216">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="134" x="144" y="555.2651">[record doesn't exist]</text><polygon fill="#454645" points="1120.5,577.3203,1130.5,581.3203,1120.5,585.3203,1124.5,581.3203" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="581.3203" y2="581.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="576.2544">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,606.4531,638.5,610.4531,648.5,614.4531,644.5,610.4531" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="610.4531" y2="610.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="654.5" y="605.3872">0 rows</text><polygon fill="#454645" points="1924,635.5859,1934,639.5859,1924,643.5859,1928,639.5859" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1930" y1="639.5859" y2="639.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="634.52">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,675.2852,638.5,679.2852,648.5,683.2852,644.5,679.2852" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1940" y1="679.2852" y2="679.2852"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="674.2192">0 row</text><path d="M280,656.0859 L280,689.0859 A3.5,3.5 0 0 0 283.5,692.5859 L618.5,692.5859 A3.5,3.5 0 0 0 622,689.0859 L622,662.5859 L612,652.5859 L283.5,652.5859 A3.5,3.5 0 0 0 280,656.0859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M612,652.5859 L612,660.8359 A1.75,1.75 0 0 0 613.75,662.5859 L622,662.5859 L612,652.5859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="286" y="669.6528">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="286" y="684.7856">and require manual intervention</text><polygon fill="#454645" points="1209.5,714.9844,1219.5,718.9844,1209.5,722.9844,1213.5,718.9844" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1215.5" y1="718.9844" y2="718.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="644.5" y="713.9185">Household Data /error_topic</text><path d="M1190,733.9844 L1273.5,733.9844 L1273.5,741.1172 L1263.5,751.1172 L1186.5,751.1172 L1186.5,737.4844 A3.5,3.5 0 0 1 1190,733.9844 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="733.9844"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="747.0513">async</text><polygon fill="#454645" points="1242.5,768.25,1232.5,772.25,1242.5,776.25,1238.5,772.25" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1675" y1="772.25" y2="772.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1248.5" y="767.1841">Consume Household Data</text><polygon fill="#454645" points="1924,827.3828,1934,831.3828,1924,835.3828,1928,831.3828" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1686" x2="1930" y1="831.3828" y2="831.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="1693" y="826.3169">Persist Household Data /error_table</text><polygon fill="#454645" points="332.5,896.5156,322.5,900.5156,332.5,904.5156,328.5,900.5156" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="900.5156" y2="900.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="895.4497">HttpStatus: 400 with appropriate error code</text><path d="M75,884.8828 L75,902.8828 A3.5,3.5 0 0 0 78.5,906.3828 L312.5,906.3828 A3.5,3.5 0 0 0 316,902.8828 L316,891.3828 L306,881.3828 L78.5,881.3828 A3.5,3.5 0 0 0 75,884.8828 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,881.3828 L306,889.6328 A1.75,1.75 0 0 0 307.75,891.3828 L316,891.3828 L306,881.3828 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="81" y="898.4497">Error Code: RECORD_NOT_FOUND</text><path d="M552,925.5156 L612.5,925.5156 L612.5,932.6484 L602.5,942.6484 L548.5,942.6484 L548.5,929.0156 A3.5,3.5 0 0 1 552,925.5156 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1439.5" x="548.5" y="925.5156"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="563.5" y="938.5825">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="197" x="627.5" y="937.7261">[record doesn't exists in cache]</text><polygon fill="#454645" points="1120.5,959.7813,1130.5,963.7813,1120.5,967.7813,1124.5,963.7813" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="963.7813" y2="963.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="958.7153">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,988.9141,638.5,992.9141,648.5,996.9141,644.5,992.9141" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="992.9141" y2="992.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="654.5" y="987.8481">0 rows</text><polygon fill="#454645" points="1924,1018.0469,1934,1022.0469,1924,1026.0469,1928,1022.0469" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1930" y1="1022.0469" y2="1022.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="1016.981">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,1047.1797,638.5,1051.1797,648.5,1055.1797,644.5,1051.1797" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1940" y1="1051.1797" y2="1051.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="1046.1138">1 row</text><polygon fill="#454645" points="1120.5,1076.3125,1130.5,1080.3125,1120.5,1084.3125,1124.5,1080.3125" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1080.3125" y2="1080.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="644.5" y="1075.2466">1 record</text><polygon fill="#454645" points="1120.5,1142.4453,1130.5,1146.4453,1120.5,1150.4453,1124.5,1146.4453" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1146.4453" y2="1146.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="644.5" y="1141.3794">Fetch the existing record</text><polygon fill="#454645" points="648.5,1171.5781,638.5,1175.5781,648.5,1179.5781,644.5,1175.5781" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="1175.5781" y2="1175.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="1170.5122">1 row</text><path d="M116.5,1190.5781 L177,1190.5781 L177,1197.7109 L167,1207.7109 L113,1207.7109 L113,1194.0781 A3.5,3.5 0 0 1 116.5,1190.5781 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="315.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1885" x="113" y="1190.5781"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="128" y="1203.645">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="141" x="192" y="1202.7886">[incorrect rowVersion]</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1228.8438" y2="1228.8438"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1228.8438" y2="1241.8438"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1241.8438" y2="1241.8438"/><polygon fill="#454645" points="648.5,1237.8438,638.5,1241.8438,648.5,1245.8438,644.5,1241.8438" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1223.7778">Compare rowVersion between request and db</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1270.9766" y2="1270.9766"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1270.9766" y2="1283.9766"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1283.9766" y2="1283.9766"/><polygon fill="#454645" points="648.5,1279.9766,638.5,1283.9766,648.5,1287.9766,644.5,1283.9766" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="644.5" y="1265.9106">Incorrect rowVersion [request: should be +1 only]</text><polygon fill="#454645" points="1214.5,1309.1094,1224.5,1313.1094,1214.5,1317.1094,1218.5,1313.1094" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1220.5" y1="1313.1094" y2="1313.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="644.5" y="1308.0435">Household Data /error_topic</text><path d="M1190,1328.1094 L1273.5,1328.1094 L1273.5,1335.2422 L1263.5,1345.2422 L1186.5,1345.2422 L1186.5,1331.6094 A3.5,3.5 0 0 1 1190,1328.1094 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="1328.1094"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="1341.1763">async</text><polygon fill="#454645" points="1237.5,1362.375,1227.5,1366.375,1237.5,1370.375,1233.5,1366.375" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1231.5" x2="1675" y1="1366.375" y2="1366.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1243.5" y="1361.3091">Consume Household Data</text><polygon fill="#454645" points="1924,1421.5078,1934,1425.5078,1924,1429.5078,1928,1425.5078" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1686" x2="1930" y1="1425.5078" y2="1425.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="1693" y="1420.4419">Persist Household Data /error_table</text><polygon fill="#454645" points="332.5,1490.6406,322.5,1494.6406,332.5,1498.6406,328.5,1494.6406" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="1494.6406" y2="1494.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="1489.5747">HttpStatus: 400 with appropriate error code</text><path d="M123,1479.0078 L123,1497.0078 A3.5,3.5 0 0 0 126.5,1500.5078 L312.5,1500.5078 A3.5,3.5 0 0 0 316,1497.0078 L316,1485.5078 L306,1475.5078 L126.5,1475.5078 A3.5,3.5 0 0 0 123,1479.0078 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,1475.5078 L306,1483.7578 A1.75,1.75 0 0 0 307.75,1485.5078 L316,1485.5078 L306,1475.5078 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="129" y="1492.5747">Error Code: BAD_REQUEST</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1533.7734" y2="1533.7734"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1533.7734" y2="1546.7734"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1546.7734" y2="1546.7734"/><polygon fill="#454645" points="648.5,1542.7734,638.5,1546.7734,648.5,1550.7734,644.5,1546.7734" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1528.7075">Compare rowVersion between request and db</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1575.9063" y2="1575.9063"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1575.9063" y2="1588.9063"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1588.9063" y2="1588.9063"/><polygon fill="#454645" points="648.5,1584.9063,638.5,1588.9063,648.5,1592.9063,644.5,1588.9063" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1570.8403">rowVersion in request = rowVersion in db + 1</text><polygon fill="#454645" points="1209.5,1614.0391,1219.5,1618.0391,1209.5,1622.0391,1213.5,1618.0391" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1215.5" y1="1618.0391" y2="1618.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="644.5" y="1612.9731">Household Data /update_topic</text><polygon fill="#454645" points="1120.5,1643.1719,1130.5,1647.1719,1120.5,1651.1719,1124.5,1647.1719" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1647.1719" y2="1647.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="476" x="644.5" y="1642.106">Update new record in cache against clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="332.5,1702.3047,322.5,1706.3047,332.5,1710.3047,328.5,1706.3047" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="631.5" y1="1706.3047" y2="1706.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="338.5" y="1701.2388">HttpStatus: 202 ACCEPTED</text><path d="M1190,1721.3047 L1273.5,1721.3047 L1273.5,1728.4375 L1263.5,1738.4375 L1186.5,1738.4375 L1186.5,1724.8047 A3.5,3.5 0 0 1 1190,1721.3047 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1186.5" y="1721.3047"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="1734.3716">async</text><polygon fill="#454645" points="1242.5,1755.5703,1232.5,1759.5703,1242.5,1763.5703,1238.5,1759.5703" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1418.5" y1="1759.5703" y2="1759.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1248.5" y="1754.5044">Consume Household Data</text><polygon fill="#454645" points="1237.5,1784.7031,1227.5,1788.7031,1237.5,1792.7031,1233.5,1788.7031" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1231.5" x2="1553" y1="1788.7031" y2="1788.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1243.5" y="1783.6372">Consume Household Data</text><polygon fill="#454645" points="1780.5,1813.8359,1790.5,1817.8359,1780.5,1821.8359,1784.5,1817.8359" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1564" x2="1786.5" y1="1817.8359" y2="1817.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1571" y="1812.77">Store Household Data</text><polygon fill="#454645" points="1924,1872.9688,1934,1876.9688,1924,1880.9688,1928,1876.9688" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1429.5" x2="1930" y1="1876.9688" y2="1876.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="1436.5" y="1871.9028">Update Household Data</text><!--MD5=[433952e10031d7f70687f15f2cb0a124]
@startuml
title Household - Update
!theme vibrant
participant Client as c
participant HouseholdRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    s -> k: Household Data /error_topic
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
alt incorrect rowVersion
    s -> s: Compare rowVersion between request and db
    s -> s: Incorrect rowVersion [request: should be +1 only]
    s -> k: Household Data /error_topic
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: BAD_REQUEST
    end note
end
s -> s: Compare rowVersion between request and db
s -> s: rowVersion in request = rowVersion in db + 1
s -> k: Household Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    deactivate k
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Household Data
    activate db
    deactivate db
    deactivate prs
end
@enduml

@startuml
title Household - Update
skinparam BackgroundColor FFFFFF
skinparam shadowing false
skinparam RoundCorner 7
skinparam ArrowColor 454645
skinparam FontColor 454645
skinparam SequenceLifeLineBorderColor 696969
skinparam SequenceGroupHeaderFontColor 454645
skinparam SequenceGroupFontColor 696969
skinparam SequenceGroupBorderColor 696969
skinparam SequenceGroupBorderThickness 1

skinparam sequenceDivider {
    BorderColor 454645
    BorderThickness 1
    FontColor 454645
}

skinparam participant {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFFFFF
    BorderThickness 1.5
}

skinparam database {
    BackgroundColor 00FFFF
    BorderColor 454645
    FontColor 454645
}

skinparam entity {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam note {
    BackgroundColor 7FFFD4
    BorderColor 454645
    FontColor 454645
    BorderThickness 1.5
}

skinparam actor {
    BackgroundColor 454645
    BorderColor 454645
    FontColor 454645
}

skinparam boundary {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam control {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam collections {
    BackgroundColor FF5F42
    BorderColor 454645
    FontColor 454645
}

skinparam queue {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFF
    BorderThickness 1.5
}
participant Client as c
participant HouseholdRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    s -> k: Household Data /error_topic
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
alt incorrect rowVersion
    s -> s: Compare rowVersion between request and db
    s -> s: Incorrect rowVersion [request: should be +1 only]
    s -> k: Household Data /error_topic
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: BAD_REQUEST
    end note
end
s -> s: Compare rowVersion between request and db
s -> s: rowVersion in request = rowVersion in db + 1
s -> k: Household Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    deactivate k
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Household Data
    activate db
    deactivate db
    deactivate prs
end
@enduml

PlantUML version 1.2022.12(Sun Oct 23 23:42:26 IST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>