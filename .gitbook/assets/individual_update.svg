<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1989px" preserveAspectRatio="none" style="width:1994px;height:1989px;background:#FFFFFF;" version="1.1" viewBox="0 0 1994 1989" width="1994px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="26.2969" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="161" x="918" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="151" x="923" y="27.9951">Individual - Update</text><rect fill="#FFFFFF" height="1549.4453" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="581.3203"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="942.6484"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1059.1797"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1125.3125"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1626.0391"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="283.8242"/><rect fill="#FFFFFF" height="303.9297" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="1596.9063"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1414.5" y="1738.4375"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1549" y="1767.5703"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="751.1172"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="1345.2422"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1787.5" y="1796.7031"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="406.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="639.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="810.25"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1000.9141"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1404.375"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1855.8359"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1979" x="9" y="192.8594"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="309.3906"/><rect fill="none" height="347.3281" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1923" x="65" y="543.0547"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="712.8516"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1426" x="552" y="904.3828"/><rect fill="none" height="315.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1875" x="113" y="1169.4453"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="1306.9766"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="1700.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="321" x2="321" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="632" x2="632" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1137.5" x2="1137.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1226.5" x2="1226.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1419.5" x2="1419.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1553.5" x2="1553.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1675.5" x2="1675.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1792.5" x2="1792.5" y1="104.5938" y2="1910.8359"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1931" x2="1931" y1="104.5938" y2="1910.8359"/><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="93.292">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="1929.8311">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="141" x="562" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="569" y="93.292">IndividualRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="141" x="562" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="569" y="1929.8311">IndividualRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1088.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1095.5" y="93.292">RedisCache</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1088.5" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1095.5" y="1929.8311">RedisCache</text><path d="M1201.5,78.2969 L1251.5,78.2969 C1256.5,78.2969 1256.5,91.4453 1256.5,91.4453 C1256.5,91.4453 1256.5,104.5938 1251.5,104.5938 L1201.5,104.5938 C1196.5,104.5938 1196.5,91.4453 1196.5,91.4453 C1196.5,91.4453 1196.5,78.2969 1201.5,78.2969 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1251.5,78.2969 C1246.5,78.2969 1246.5,91.4453 1246.5,91.4453 C1246.5,104.5938 1251.5,104.5938 1251.5,104.5938 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1201.5" y="96.292">Kafka</text><path d="M1201.5,1909.8359 L1251.5,1909.8359 C1256.5,1909.8359 1256.5,1922.9844 1256.5,1922.9844 C1256.5,1922.9844 1256.5,1936.1328 1251.5,1936.1328 L1201.5,1936.1328 C1196.5,1936.1328 1196.5,1922.9844 1196.5,1922.9844 C1196.5,1922.9844 1196.5,1909.8359 1201.5,1909.8359 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1251.5,1909.8359 C1246.5,1909.8359 1246.5,1922.9844 1246.5,1922.9844 C1246.5,1936.1328 1251.5,1936.1328 1251.5,1936.1328 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1201.5" y="1927.8311">Kafka</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1355.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1362.5" y="93.292">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1355.5" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1362.5" y="1929.8311">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1493.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1500.5" y="93.292">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1493.5" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1500.5" y="1929.8311">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1624.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1631.5" y="93.292">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1624.5" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1631.5" y="1929.8311">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1737.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1744.5" y="93.292">ElasticSearch</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1737.5" y="1909.8359"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1744.5" y="1929.8311">ElasticSearch</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1894" y="101.292">Database</text><path d="M1913,52.2969 C1913,42.2969 1931,42.2969 1931,42.2969 C1931,42.2969 1949,42.2969 1949,52.2969 L1949,78.2969 C1949,88.2969 1931,88.2969 1931,88.2969 C1931,88.2969 1913,88.2969 1913,78.2969 L1913,52.2969 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1913,52.2969 C1913,62.2969 1931,62.2969 1931,62.2969 C1931,62.2969 1949,62.2969 1949,52.2969 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1894" y="1922.8311">Database</text><path d="M1913,1936.1328 C1913,1926.1328 1931,1926.1328 1931,1926.1328 C1931,1926.1328 1949,1926.1328 1949,1936.1328 L1949,1962.1328 C1949,1972.1328 1931,1972.1328 1931,1972.1328 C1931,1972.1328 1913,1972.1328 1913,1962.1328 L1913,1936.1328 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1913,1936.1328 C1913,1946.1328 1931,1946.1328 1931,1946.1328 C1931,1946.1328 1949,1946.1328 1949,1936.1328 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><rect fill="#FFFFFF" height="1549.4453" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="581.3203"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="942.6484"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1059.1797"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1125.3125"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1132.5" y="1626.0391"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="283.8242"/><rect fill="#FFFFFF" height="303.9297" style="stroke:#696969;stroke-width:1.0;" width="10" x="1221.5" y="1596.9063"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1414.5" y="1738.4375"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1549" y="1767.5703"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="751.1172"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1671" y="1345.2422"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1787.5" y="1796.7031"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="406.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="639.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="810.25"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1000.9141"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1404.375"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1926" y="1855.8359"/><polygon fill="#454645" points="615.5,131.7266,625.5,135.7266,615.5,139.7266,619.5,135.7266" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="321.5" x2="621.5" y1="135.7266" y2="135.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="328.5" y="130.6606">/individual/v1/_update</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="164.8594" y2="164.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="164.8594" y2="177.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="177.8594" y2="177.8594"/><polygon fill="#454645" points="648.5,173.8594,638.5,177.8594,648.5,181.8594,644.5,177.8594" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="644.5" y="159.7935">Validate request body</text><path d="M12.5,192.8594 L73,192.8594 L73,199.9922 L63,209.9922 L9,209.9922 L9,196.3594 A3.5,3.5 0 0 1 12.5,192.8594 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1979" x="9" y="192.8594"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="24" y="205.9263">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88" y="205.0698">[request validation fails]</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="231.125" y2="231.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="231.125" y2="244.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="244.125" y2="244.125"/><polygon fill="#454645" points="648.5,240.125,638.5,244.125,648.5,248.125,644.5,244.125" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="644.5" y="226.0591">Request validation failed</text><polygon fill="#454645" points="1209.5,279.8242,1219.5,283.8242,1209.5,287.8242,1213.5,283.8242" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1215.5" y1="283.8242" y2="283.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="644.5" y="278.7583">Individual Data /error_topic</text><path d="M280,260.625 L280,293.625 A3.5,3.5 0 0 0 283.5,297.125 L618.5,297.125 A3.5,3.5 0 0 0 622,293.625 L622,267.125 L612,257.125 L283.5,257.125 A3.5,3.5 0 0 0 280,260.625 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M612,257.125 L612,265.375 A1.75,1.75 0 0 0 613.75,267.125 L622,267.125 L612,257.125 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="286" y="274.1919">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="286" y="289.3247">and require manual intervention</text><path d="M1190,309.3906 L1273.5,309.3906 L1273.5,316.5234 L1263.5,326.5234 L1186.5,326.5234 L1186.5,312.8906 A3.5,3.5 0 0 1 1190,309.3906 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="309.3906"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="322.4575">async</text><polygon fill="#454645" points="1242.5,343.6563,1232.5,347.6563,1242.5,351.6563,1238.5,347.6563" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1670" y1="347.6563" y2="347.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1248.5" y="342.5903">Consume Individual Data</text><polygon fill="#454645" points="1914,402.7891,1924,406.7891,1914,410.7891,1918,406.7891" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1681" x2="1920" y1="406.7891" y2="406.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1688" y="401.7231">Persist Individual Data /error_table</text><polygon fill="#454645" points="332.5,471.9219,322.5,475.9219,332.5,479.9219,328.5,475.9219" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="475.9219" y2="475.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="470.856">HttpStatus: 400 with appropriate error code</text><path d="M19,460.2891 L19,478.2891 A3.5,3.5 0 0 0 22.5,481.7891 L312.5,481.7891 A3.5,3.5 0 0 0 316,478.2891 L316,466.7891 L306,456.7891 L22.5,456.7891 A3.5,3.5 0 0 0 19,460.2891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,456.7891 L306,465.0391 A1.75,1.75 0 0 0 307.75,466.7891 L316,466.7891 L306,456.7891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="276" x="25" y="473.856">Error Code: REQUEST_VALIDATION_FAILED</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="515.0547" y2="515.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="515.0547" y2="528.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="528.0547" y2="528.0547"/><polygon fill="#454645" points="648.5,524.0547,638.5,528.0547,648.5,532.0547,644.5,528.0547" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="644.5" y="509.9888">Request validation successful</text><path d="M68.5,543.0547 L129,543.0547 L129,550.1875 L119,560.1875 L65,560.1875 L65,546.5547 A3.5,3.5 0 0 1 68.5,543.0547 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="347.3281" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1923" x="65" y="543.0547"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="80" y="556.1216">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="134" x="144" y="555.2651">[record doesn't exist]</text><polygon fill="#454645" points="1120.5,577.3203,1130.5,581.3203,1120.5,585.3203,1124.5,581.3203" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="581.3203" y2="581.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="576.2544">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,606.4531,638.5,610.4531,648.5,614.4531,644.5,610.4531" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="610.4531" y2="610.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="654.5" y="605.3872">0 rows</text><polygon fill="#454645" points="1914,635.5859,1924,639.5859,1914,643.5859,1918,639.5859" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1920" y1="639.5859" y2="639.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="634.52">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,664.7188,638.5,668.7188,648.5,672.7188,644.5,668.7188" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1930" y1="668.7188" y2="668.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="663.6528">0 row</text><polygon fill="#454645" points="1214.5,693.8516,1224.5,697.8516,1214.5,701.8516,1218.5,697.8516" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1220.5" y1="697.8516" y2="697.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="644.5" y="692.7856">Individual Data /error_topic</text><path d="M1190,712.8516 L1273.5,712.8516 L1273.5,719.9844 L1263.5,729.9844 L1186.5,729.9844 L1186.5,716.3516 A3.5,3.5 0 0 1 1190,712.8516 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="712.8516"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="725.9185">async</text><polygon fill="#454645" points="1237.5,747.1172,1227.5,751.1172,1237.5,755.1172,1233.5,751.1172" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1231.5" x2="1670" y1="751.1172" y2="751.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1243.5" y="746.0513">Consume Individual Data</text><polygon fill="#454645" points="1914,806.25,1924,810.25,1914,814.25,1918,810.25" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1681" x2="1920" y1="810.25" y2="810.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1688" y="805.1841">Persist Individual Data /error_table</text><polygon fill="#454645" points="332.5,875.3828,322.5,879.3828,332.5,883.3828,328.5,879.3828" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="879.3828" y2="879.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="874.3169">HttpStatus: 400 with appropriate error code</text><path d="M75,863.75 L75,881.75 A3.5,3.5 0 0 0 78.5,885.25 L312.5,885.25 A3.5,3.5 0 0 0 316,881.75 L316,870.25 L306,860.25 L78.5,860.25 A3.5,3.5 0 0 0 75,863.75 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,860.25 L306,868.5 A1.75,1.75 0 0 0 307.75,870.25 L316,870.25 L306,860.25 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="81" y="877.3169">Error Code: RECORD_NOT_FOUND</text><path d="M555.5,904.3828 L616,904.3828 L616,911.5156 L606,921.5156 L552,921.5156 L552,907.8828 A3.5,3.5 0 0 1 555.5,904.3828 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="192.7969" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1426" x="552" y="904.3828"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="567" y="917.4497">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="197" x="631" y="916.5933">[record doesn't exists in cache]</text><polygon fill="#454645" points="1120.5,938.6484,1130.5,942.6484,1120.5,946.6484,1124.5,942.6484" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="942.6484" y2="942.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="937.5825">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,967.7813,638.5,971.7813,648.5,975.7813,644.5,971.7813" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="971.7813" y2="971.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="654.5" y="966.7153">0 rows</text><polygon fill="#454645" points="1914,996.9141,1924,1000.9141,1914,1004.9141,1918,1000.9141" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1920" y1="1000.9141" y2="1000.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="644.5" y="995.8481">Search record based on clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,1026.0469,638.5,1030.0469,648.5,1034.0469,644.5,1030.0469" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1930" y1="1030.0469" y2="1030.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="1024.981">1 row</text><polygon fill="#454645" points="1120.5,1055.1797,1130.5,1059.1797,1120.5,1063.1797,1124.5,1059.1797" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1059.1797" y2="1059.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="644.5" y="1054.1138">1 record</text><polygon fill="#454645" points="1120.5,1121.3125,1130.5,1125.3125,1120.5,1129.3125,1124.5,1125.3125" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1125.3125" y2="1125.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="644.5" y="1120.2466">Fetch the existing record</text><polygon fill="#454645" points="648.5,1150.4453,638.5,1154.4453,648.5,1158.4453,644.5,1154.4453" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1136.5" y1="1154.4453" y2="1154.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="1149.3794">1 row</text><path d="M116.5,1169.4453 L177,1169.4453 L177,1176.5781 L167,1186.5781 L113,1186.5781 L113,1172.9453 A3.5,3.5 0 0 1 116.5,1169.4453 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="315.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1875" x="113" y="1169.4453"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="128" y="1182.5122">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="141" x="192" y="1181.6558">[incorrect rowVersion]</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1207.7109" y2="1207.7109"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1207.7109" y2="1220.7109"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1220.7109" y2="1220.7109"/><polygon fill="#454645" points="648.5,1216.7109,638.5,1220.7109,648.5,1224.7109,644.5,1220.7109" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1202.645">Compare rowVersion between request and db</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1249.8438" y2="1249.8438"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1249.8438" y2="1262.8438"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1262.8438" y2="1262.8438"/><polygon fill="#454645" points="648.5,1258.8438,638.5,1262.8438,648.5,1266.8438,644.5,1262.8438" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="644.5" y="1244.7778">Incorrect rowVersion [request: should be +1 only]</text><polygon fill="#454645" points="1214.5,1287.9766,1224.5,1291.9766,1214.5,1295.9766,1218.5,1291.9766" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1220.5" y1="1291.9766" y2="1291.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="644.5" y="1286.9106">Individual Data /error_topic</text><path d="M1190,1306.9766 L1273.5,1306.9766 L1273.5,1314.1094 L1263.5,1324.1094 L1186.5,1324.1094 L1186.5,1310.4766 A3.5,3.5 0 0 1 1190,1306.9766 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="1306.9766"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="1320.0435">async</text><polygon fill="#454645" points="1237.5,1341.2422,1227.5,1345.2422,1237.5,1349.2422,1233.5,1345.2422" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1231.5" x2="1670" y1="1345.2422" y2="1345.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1243.5" y="1340.1763">Consume Individual Data</text><polygon fill="#454645" points="1914,1400.375,1924,1404.375,1914,1408.375,1918,1404.375" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1681" x2="1920" y1="1404.375" y2="1404.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1688" y="1399.3091">Persist Individual Data /error_table</text><polygon fill="#454645" points="332.5,1469.5078,322.5,1473.5078,332.5,1477.5078,328.5,1473.5078" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="1473.5078" y2="1473.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="1468.4419">HttpStatus: 400 with appropriate error code</text><path d="M123,1457.875 L123,1475.875 A3.5,3.5 0 0 0 126.5,1479.375 L312.5,1479.375 A3.5,3.5 0 0 0 316,1475.875 L316,1464.375 L306,1454.375 L126.5,1454.375 A3.5,3.5 0 0 0 123,1457.875 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,1454.375 L306,1462.625 A1.75,1.75 0 0 0 307.75,1464.375 L316,1464.375 L306,1454.375 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="129" y="1471.4419">Error Code: BAD_REQUEST</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1512.6406" y2="1512.6406"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1512.6406" y2="1525.6406"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1525.6406" y2="1525.6406"/><polygon fill="#454645" points="648.5,1521.6406,638.5,1525.6406,648.5,1529.6406,644.5,1525.6406" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1507.5747">Compare rowVersion between request and db</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1554.7734" y2="1554.7734"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1554.7734" y2="1567.7734"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1567.7734" y2="1567.7734"/><polygon fill="#454645" points="648.5,1563.7734,638.5,1567.7734,648.5,1571.7734,644.5,1567.7734" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="644.5" y="1549.7075">rowVersion in request = rowVersion in db + 1</text><polygon fill="#454645" points="1209.5,1592.9063,1219.5,1596.9063,1209.5,1600.9063,1213.5,1596.9063" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1215.5" y1="1596.9063" y2="1596.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="644.5" y="1591.8403">Individual Data /update_topic</text><polygon fill="#454645" points="1120.5,1622.0391,1130.5,1626.0391,1120.5,1630.0391,1124.5,1626.0391" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1126.5" y1="1626.0391" y2="1626.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="476" x="644.5" y="1620.9731">Update new record in cache against clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="332.5,1681.1719,322.5,1685.1719,332.5,1689.1719,328.5,1685.1719" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="631.5" y1="1685.1719" y2="1685.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="338.5" y="1680.106">HttpStatus: 202 ACCEPTED</text><path d="M1190,1700.1719 L1273.5,1700.1719 L1273.5,1707.3047 L1263.5,1717.3047 L1186.5,1717.3047 L1186.5,1703.6719 A3.5,3.5 0 0 1 1190,1700.1719 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="791.5" x="1186.5" y="1700.1719"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1201.5" y="1713.2388">async</text><polygon fill="#454645" points="1242.5,1734.4375,1232.5,1738.4375,1242.5,1742.4375,1238.5,1738.4375" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1413.5" y1="1738.4375" y2="1738.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1248.5" y="1733.3716">Consume Individual Data</text><polygon fill="#454645" points="1242.5,1763.5703,1232.5,1767.5703,1242.5,1771.5703,1238.5,1767.5703" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1236.5" x2="1548" y1="1767.5703" y2="1767.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1248.5" y="1762.5044">Consume Individual Data</text><polygon fill="#454645" points="1775.5,1792.7031,1785.5,1796.7031,1775.5,1800.7031,1779.5,1796.7031" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1559" x2="1781.5" y1="1796.7031" y2="1796.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="1566" y="1791.6372">Store Individual Data</text><polygon fill="#454645" points="1914,1851.8359,1924,1855.8359,1914,1859.8359,1918,1855.8359" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1424.5" x2="1920" y1="1855.8359" y2="1855.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="1431.5" y="1850.77">Update Individual Data</text><!--MD5=[847773c82e36a790c70b479f80d85479]
@startuml
title Individual - Update
!theme vibrant
participant Client as c
participant IndividualRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /individual/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Individual Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    s -> k: Individual Data /error_topic
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
alt incorrect rowVersion
    s -> s: Compare rowVersion between request and db
    s -> s: Incorrect rowVersion [request: should be +1 only]
    s -> k: Individual Data /error_topic
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: BAD_REQUEST
    end note
end
s -> s: Compare rowVersion between request and db
s -> s: rowVersion in request = rowVersion in db + 1
s -> k: Individual Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Individual Data
    activate prs
    idx -> k: Consume Individual Data
    activate idx
    idx -> el: Store Individual Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Individual Data
    activate db
    deactivate db
    deactivate prs
end
deactivate k
@enduml

@startuml
title Individual - Update
skinparam BackgroundColor FFFFFF
skinparam shadowing false
skinparam RoundCorner 7
skinparam ArrowColor 454645
skinparam FontColor 454645
skinparam SequenceLifeLineBorderColor 696969
skinparam SequenceGroupHeaderFontColor 454645
skinparam SequenceGroupFontColor 696969
skinparam SequenceGroupBorderColor 696969
skinparam SequenceGroupBorderThickness 1

skinparam sequenceDivider {
    BorderColor 454645
    BorderThickness 1
    FontColor 454645
}

skinparam participant {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFFFFF
    BorderThickness 1.5
}

skinparam database {
    BackgroundColor 00FFFF
    BorderColor 454645
    FontColor 454645
}

skinparam entity {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam note {
    BackgroundColor 7FFFD4
    BorderColor 454645
    FontColor 454645
    BorderThickness 1.5
}

skinparam actor {
    BackgroundColor 454645
    BorderColor 454645
    FontColor 454645
}

skinparam boundary {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam control {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam collections {
    BackgroundColor FF5F42
    BorderColor 454645
    FontColor 454645
}

skinparam queue {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFF
    BorderThickness 1.5
}
participant Client as c
participant IndividualRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /individual/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Individual Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    s -> k: Individual Data /error_topic
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
alt incorrect rowVersion
    s -> s: Compare rowVersion between request and db
    s -> s: Incorrect rowVersion [request: should be +1 only]
    s -> k: Individual Data /error_topic
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: BAD_REQUEST
    end note
end
s -> s: Compare rowVersion between request and db
s -> s: rowVersion in request = rowVersion in db + 1
s -> k: Individual Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Individual Data
    activate prs
    idx -> k: Consume Individual Data
    activate idx
    idx -> el: Store Individual Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Individual Data
    activate db
    deactivate db
    deactivate prs
end
deactivate k
@enduml

PlantUML version 1.2022.12(Sun Oct 23 23:42:26 IST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>