<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1740px" preserveAspectRatio="none" style="width:2064px;height:1740px;background:#FFFFFF;" version="1.1" viewBox="0 0 2064 1740" width="2064px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="26.2969" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="164" x="951.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="154" x="956.5" y="27.9951">Household - Create</text><rect fill="#FFFFFF" height="1300.7813" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="605.4531"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="705.8516"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="822.3828"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="1377.375"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="283.8242"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="1016.6133"/><rect fill="#FFFFFF" height="303.9297" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="1348.2422"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1425.5" y="1489.7734"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1560" y="1518.9063"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1682" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1682" y="1080.4453"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1798.5" y="1548.0391"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="406.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="764.1172"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="1139.5781"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="1607.1719"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="2016" y="947.7813"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="2016" y="1247.8438"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1995" x="9" y="192.8594"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="309.3906"/><rect fill="none" height="352.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1969" x="25" y="543.0547"/><rect fill="none" height="110.5313" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1167.5" x="35" y="567.1875"/><rect fill="none" height="310.1953" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="2008" x="50" y="909.5156"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="1042.1797"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="1451.5078"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="321" x2="321" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="632.5" x2="632.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="915" x2="915" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1143.5" x2="1143.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1232.5" x2="1232.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1430.5" x2="1430.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1564.5" x2="1564.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1686.5" x2="1686.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1803.5" x2="1803.5" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1947" x2="1947" y1="104.5938" y2="1662.1719"/><line style="stroke:#696969;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2021" x2="2021" y1="104.5938" y2="1662.1719"/><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="93.292">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="55" x="294" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="301" y="1681.167">Client</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="558.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="565.5" y="93.292">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="148" x="558.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="565.5" y="1681.167">HouseholdRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="141" x="845" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="852" y="93.292">IndividualRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="141" x="845" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="852" y="1681.167">IndividualRegistry</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1094.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1101.5" y="93.292">RedisCache</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="98" x="1094.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="1101.5" y="1681.167">RedisCache</text><path d="M1207.5,78.2969 L1257.5,78.2969 C1262.5,78.2969 1262.5,91.4453 1262.5,91.4453 C1262.5,91.4453 1262.5,104.5938 1257.5,104.5938 L1207.5,104.5938 C1202.5,104.5938 1202.5,91.4453 1202.5,91.4453 C1202.5,91.4453 1202.5,78.2969 1207.5,78.2969 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1257.5,78.2969 C1252.5,78.2969 1252.5,91.4453 1252.5,91.4453 C1252.5,104.5938 1257.5,104.5938 1257.5,104.5938 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1207.5" y="96.292">Kafka</text><path d="M1207.5,1661.1719 L1257.5,1661.1719 C1262.5,1661.1719 1262.5,1674.3203 1262.5,1674.3203 C1262.5,1674.3203 1262.5,1687.4688 1257.5,1687.4688 L1207.5,1687.4688 C1202.5,1687.4688 1202.5,1674.3203 1202.5,1674.3203 C1202.5,1674.3203 1202.5,1661.1719 1207.5,1661.1719 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5;"/><path d="M1257.5,1661.1719 C1252.5,1661.1719 1252.5,1674.3203 1252.5,1674.3203 C1252.5,1687.4688 1257.5,1687.4688 1257.5,1687.4688 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="1207.5" y="1679.167">Kafka</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1366.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1373.5" y="93.292">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="128" x="1366.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1373.5" y="1681.167">PersisterService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1504.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1511.5" y="93.292">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="121" x="1504.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1511.5" y="1681.167">IndexerService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1635.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1642.5" y="93.292">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="103" x="1635.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1642.5" y="1681.167">ErrorService</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1748.5" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1755.5" y="93.292">ElasticSearch</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="110" x="1748.5" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="1755.5" y="1681.167">ElasticSearch</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1910" y="101.292">Database</text><path d="M1929,52.2969 C1929,42.2969 1947,42.2969 1947,42.2969 C1947,42.2969 1965,42.2969 1965,52.2969 L1965,78.2969 C1965,88.2969 1947,88.2969 1947,88.2969 C1947,88.2969 1929,88.2969 1929,78.2969 L1929,52.2969 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1929,52.2969 C1929,62.2969 1947,62.2969 1947,62.2969 C1947,62.2969 1965,62.2969 1965,52.2969 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="1910" y="1674.167">Database</text><path d="M1929,1687.4688 C1929,1677.4688 1947,1677.4688 1947,1677.4688 C1947,1677.4688 1965,1677.4688 1965,1687.4688 L1965,1713.4688 C1965,1723.4688 1947,1723.4688 1947,1723.4688 C1947,1723.4688 1929,1723.4688 1929,1713.4688 L1929,1687.4688 " fill="#00FFFF" style="stroke:#454645;stroke-width:1.5;"/><path d="M1929,1687.4688 C1929,1697.4688 1947,1697.4688 1947,1697.4688 C1947,1697.4688 1965,1697.4688 1965,1687.4688 " fill="none" style="stroke:#454645;stroke-width:1.5;"/><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="54" x="1994" y="73.2969"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="2001" y="93.292">idgen</text><rect fill="#FF6347" height="30.2969" rx="3.5" ry="3.5" style="stroke:#454645;stroke-width:1.5;" width="54" x="1994" y="1661.1719"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="2001" y="1681.167">idgen</text><rect fill="#FFFFFF" height="1300.7813" style="stroke:#696969;stroke-width:1.0;" width="10" x="627.5" y="135.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="605.4531"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="705.8516"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="822.3828"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1138.5" y="1377.375"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="283.8242"/><rect fill="#FFFFFF" height="93.832" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="1016.6133"/><rect fill="#FFFFFF" height="303.9297" style="stroke:#696969;stroke-width:1.0;" width="10" x="1227.5" y="1348.2422"/><rect fill="#FFFFFF" height="147.3984" style="stroke:#696969;stroke-width:1.0;" width="10" x="1425.5" y="1489.7734"/><rect fill="#FFFFFF" height="59.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1560" y="1518.9063"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1682" y="347.6563"/><rect fill="#FFFFFF" height="89.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1682" y="1080.4453"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1798.5" y="1548.0391"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="406.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="764.1172"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="1139.5781"/><rect fill="#FFFFFF" height="30" style="stroke:#696969;stroke-width:1.0;" width="10" x="1942" y="1607.1719"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="2016" y="947.7813"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#696969;stroke-width:1.0;" width="10" x="2016" y="1247.8438"/><polygon fill="#454645" points="615.5,131.7266,625.5,135.7266,615.5,139.7266,619.5,135.7266" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="321.5" x2="621.5" y1="135.7266" y2="135.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="328.5" y="130.6606">/household/v1/_create</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="164.8594" y2="164.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="164.8594" y2="177.8594"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="177.8594" y2="177.8594"/><polygon fill="#454645" points="648.5,173.8594,638.5,177.8594,648.5,181.8594,644.5,177.8594" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="644.5" y="159.7935">Validate request body</text><path d="M12.5,192.8594 L73,192.8594 L73,199.9922 L63,209.9922 L9,209.9922 L9,196.3594 A3.5,3.5 0 0 1 12.5,192.8594 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="294.0625" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1995" x="9" y="192.8594"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="24" y="205.9263">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88" y="205.0698">[request validation fails]</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="231.125" y2="231.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="231.125" y2="244.125"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="244.125" y2="244.125"/><polygon fill="#454645" points="648.5,240.125,638.5,244.125,648.5,248.125,644.5,244.125" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="644.5" y="226.0591">Request validation failed</text><polygon fill="#454645" points="1215.5,279.8242,1225.5,283.8242,1215.5,287.8242,1219.5,283.8242" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1221.5" y1="283.8242" y2="283.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="644.5" y="278.7583">Household Data /error_topic</text><path d="M280,260.625 L280,293.625 A3.5,3.5 0 0 0 283.5,297.125 L618.5,297.125 A3.5,3.5 0 0 0 622,293.625 L622,267.125 L612,257.125 L283.5,257.125 A3.5,3.5 0 0 0 280,260.625 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M612,257.125 L612,265.375 A1.75,1.75 0 0 0 613.75,267.125 L622,267.125 L612,257.125 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="286" y="274.1919">This will be marked as unrecoverable right away</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="286" y="289.3247">and require manual intervention</text><path d="M1196,309.3906 L1279.5,309.3906 L1279.5,316.5234 L1269.5,326.5234 L1192.5,326.5234 L1192.5,312.8906 A3.5,3.5 0 0 1 1196,309.3906 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="309.3906"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1207.5" y="322.4575">async</text><polygon fill="#454645" points="1248.5,343.6563,1238.5,347.6563,1248.5,351.6563,1244.5,347.6563" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1242.5" x2="1681" y1="347.6563" y2="347.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1254.5" y="342.5903">Consume Household Data</text><polygon fill="#454645" points="1930,402.7891,1940,406.7891,1930,410.7891,1934,406.7891" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1692" x2="1936" y1="406.7891" y2="406.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="1699" y="401.7231">Persist Household Data /error_table</text><polygon fill="#454645" points="332.5,471.9219,322.5,475.9219,332.5,479.9219,328.5,475.9219" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="475.9219" y2="475.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="470.856">HttpStatus: 400 with appropriate error code</text><path d="M19,460.2891 L19,478.2891 A3.5,3.5 0 0 0 22.5,481.7891 L312.5,481.7891 A3.5,3.5 0 0 0 316,478.2891 L316,466.7891 L306,456.7891 L22.5,456.7891 A3.5,3.5 0 0 0 19,460.2891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,456.7891 L306,465.0391 A1.75,1.75 0 0 0 307.75,466.7891 L316,466.7891 L306,456.7891 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="276" x="25" y="473.856">Error Code: REQUEST_VALIDATION_FAILED</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="515.0547" y2="515.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="515.0547" y2="528.0547"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="528.0547" y2="528.0547"/><polygon fill="#454645" points="648.5,524.0547,638.5,528.0547,648.5,532.0547,644.5,528.0547" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="644.5" y="509.9888">Request validation successful</text><path d="M28.5,543.0547 L89,543.0547 L89,550.1875 L79,560.1875 L25,560.1875 L25,546.5547 A3.5,3.5 0 0 1 28.5,543.0547 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="352.4609" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1969" x="25" y="543.0547"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="40" y="556.1216">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="140" x="104" y="555.2651">[record already exists]</text><path d="M38.5,567.1875 L99,567.1875 L99,574.3203 L89,584.3203 L35,584.3203 L35,570.6875 A3.5,3.5 0 0 1 38.5,567.1875 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="110.5313" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="1167.5" x="35" y="567.1875"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="50" y="580.2544">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="114" y="579.3979">[record found in cache]</text><polygon fill="#454645" points="1126.5,601.4531,1136.5,605.4531,1126.5,609.4531,1130.5,605.4531" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1132.5" y1="605.4531" y2="605.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="322" x="644.5" y="600.3872">Check using clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,630.5859,638.5,634.5859,648.5,638.5859,644.5,634.5859" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1142.5" y1="634.5859" y2="634.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="629.52">1 row</text><polygon fill="#454645" points="332.5,662.7188,322.5,666.7188,332.5,670.7188,328.5,666.7188" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="666.7188" y2="666.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="661.6528">HttpStatus: 400 with appropriate error code</text><path d="M45,651.0859 L45,669.0859 A3.5,3.5 0 0 0 48.5,672.5859 L312.5,672.5859 A3.5,3.5 0 0 0 316,669.0859 L316,657.5859 L306,647.5859 L48.5,647.5859 A3.5,3.5 0 0 0 45,651.0859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,647.5859 L306,655.8359 A1.75,1.75 0 0 0 307.75,657.5859 L316,657.5859 L306,647.5859 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250" x="51" y="664.6528">Error Code: RECORD_ALREADY_EXISTS</text><polygon fill="#454645" points="1126.5,701.8516,1136.5,705.8516,1126.5,709.8516,1130.5,705.8516" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1132.5" y1="705.8516" y2="705.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="322" x="644.5" y="700.7856">Check using clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="648.5,730.9844,638.5,734.9844,648.5,738.9844,644.5,734.9844" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1142.5" y1="734.9844" y2="734.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="654.5" y="729.9185">0 rows</text><polygon fill="#454645" points="1930,760.1172,1940,764.1172,1930,768.1172,1934,764.1172" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1936" y1="764.1172" y2="764.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="644.5" y="759.0513">Check if record already exists</text><polygon fill="#454645" points="648.5,789.25,638.5,793.25,648.5,797.25,644.5,793.25" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="1946" y1="793.25" y2="793.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="36" x="654.5" y="788.1841">1 row</text><polygon fill="#454645" points="1126.5,818.3828,1136.5,822.3828,1126.5,826.3828,1130.5,822.3828" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1132.5" y1="822.3828" y2="822.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="394" x="644.5" y="817.3169">Put data in cache using clientReferenceId/serverGeneratedId</text><polygon fill="#454645" points="332.5,880.5156,322.5,884.5156,332.5,888.5156,328.5,884.5156" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="884.5156" y2="884.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="879.4497">HttpStatus: 400 with appropriate error code</text><path d="M45,868.8828 L45,886.8828 A3.5,3.5 0 0 0 48.5,890.3828 L312.5,890.3828 A3.5,3.5 0 0 0 316,886.8828 L316,875.3828 L306,865.3828 L48.5,865.3828 A3.5,3.5 0 0 0 45,868.8828 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,865.3828 L306,873.6328 A1.75,1.75 0 0 0 307.75,875.3828 L316,875.3828 L306,865.3828 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250" x="51" y="882.4497">Error Code: RECORD_ALREADY_EXISTS</text><path d="M53.5,909.5156 L114,909.5156 L114,916.6484 L104,926.6484 L50,926.6484 L50,913.0156 A3.5,3.5 0 0 1 53.5,909.5156 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="310.1953" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="2008" x="50" y="909.5156"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="65" y="922.5825">alt</text><text fill="#696969" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="124" x="129" y="921.7261">[id generation fails]</text><polygon fill="#454645" points="2004,943.7813,2014,947.7813,2004,951.7813,2008,947.7813" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="2010" y1="947.7813" y2="947.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="644.5" y="942.7153">/id/_generate</text><polygon fill="#454645" points="648.5,972.9141,638.5,976.9141,648.5,980.9141,644.5,976.9141" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="2020" y1="976.9141" y2="976.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="654.5" y="971.8481">HttpStatus: 400</text><polygon fill="#454645" points="1215.5,1012.6133,1225.5,1016.6133,1215.5,1020.6133,1219.5,1016.6133" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1221.5" y1="1016.6133" y2="1016.6133"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="644.5" y="1011.5474">Household Data /error_topic</text><path d="M341,993.4141 L341,1026.4141 A3.5,3.5 0 0 0 344.5,1029.9141 L618.5,1029.9141 A3.5,3.5 0 0 0 622,1026.4141 L622,999.9141 L612,989.9141 L344.5,989.9141 A3.5,3.5 0 0 0 341,993.4141 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M612,989.9141 L612,998.1641 A1.75,1.75 0 0 0 613.75,999.9141 L622,999.9141 L612,989.9141 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="347" y="1006.981">This will be marked as recoverable and</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="347" y="1022.1138">will be retried later</text><path d="M1196,1042.1797 L1279.5,1042.1797 L1279.5,1049.3125 L1269.5,1059.3125 L1192.5,1059.3125 L1192.5,1045.6797 A3.5,3.5 0 0 1 1196,1042.1797 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="135.3984" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="1042.1797"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1207.5" y="1055.2466">async</text><polygon fill="#454645" points="1248.5,1076.4453,1238.5,1080.4453,1248.5,1084.4453,1244.5,1080.4453" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1242.5" x2="1681" y1="1080.4453" y2="1080.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1254.5" y="1075.3794">Consume Household Data</text><polygon fill="#454645" points="1930,1135.5781,1940,1139.5781,1930,1143.5781,1934,1139.5781" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1692" x2="1936" y1="1139.5781" y2="1139.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="1699" y="1134.5122">Persist Household Data /error_table</text><polygon fill="#454645" points="332.5,1204.7109,322.5,1208.7109,332.5,1212.7109,328.5,1208.7109" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="626.5" y1="1208.7109" y2="1208.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="338.5" y="1203.645">HttpStatus: 500 with appropriate error code</text><path d="M60,1193.0781 L60,1211.0781 A3.5,3.5 0 0 0 63.5,1214.5781 L312.5,1214.5781 A3.5,3.5 0 0 0 316,1211.0781 L316,1199.5781 L306,1189.5781 L63.5,1189.5781 A3.5,3.5 0 0 0 60,1193.0781 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><path d="M306,1189.5781 L306,1197.8281 A1.75,1.75 0 0 0 307.75,1199.5781 L316,1199.5781 L306,1189.5781 " fill="#7FFFD4" style="stroke:#181818;stroke-width:1.5;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="66" y="1206.645">Error Code: ID_GENERATION_FAILED</text><polygon fill="#454645" points="2004,1243.8438,2014,1247.8438,2004,1251.8438,2008,1247.8438" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="2010" y1="1247.8438" y2="1247.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="644.5" y="1242.7778">Generate ID</text><polygon fill="#454645" points="648.5,1272.9766,638.5,1276.9766,648.5,1280.9766,644.5,1276.9766" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="642.5" x2="2020" y1="1276.9766" y2="1276.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="654.5" y="1271.9106">Generated ID</text><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="679.5" y1="1306.1094" y2="1306.1094"/><line style="stroke:#454645;stroke-width:1.0;" x1="679.5" x2="679.5" y1="1306.1094" y2="1319.1094"/><line style="stroke:#454645;stroke-width:1.0;" x1="638.5" x2="679.5" y1="1319.1094" y2="1319.1094"/><polygon fill="#454645" points="648.5,1315.1094,638.5,1319.1094,648.5,1323.1094,644.5,1319.1094" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="259" x="644.5" y="1301.0435">Update generated ID in Household Data</text><polygon fill="#454645" points="1215.5,1344.2422,1225.5,1348.2422,1215.5,1352.2422,1219.5,1348.2422" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1221.5" y1="1348.2422" y2="1348.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="644.5" y="1343.1763">Household Data /persist_topic</text><polygon fill="#454645" points="1126.5,1373.375,1136.5,1377.375,1126.5,1381.375,1130.5,1377.375" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="637.5" x2="1132.5" y1="1377.375" y2="1377.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="482" x="644.5" y="1372.3091">Put Household Data against clientReferenceId/serverGeneratedId in cache</text><polygon fill="#454645" points="332.5,1432.5078,322.5,1436.5078,332.5,1440.5078,328.5,1436.5078" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="326.5" x2="631.5" y1="1436.5078" y2="1436.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="338.5" y="1431.4419">HttpStatus: 202 ACCEPTED</text><path d="M1196,1451.5078 L1279.5,1451.5078 L1279.5,1458.6406 L1269.5,1468.6406 L1192.5,1468.6406 L1192.5,1455.0078 A3.5,3.5 0 0 1 1196,1451.5078 " fill="#EEEEEE" style="stroke:#696969;stroke-width:1.5;"/><rect fill="none" height="193.6641" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1.0;" width="801.5" x="1192.5" y="1451.5078"/><text fill="#454645" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1207.5" y="1464.5747">async</text><polygon fill="#454645" points="1248.5,1485.7734,1238.5,1489.7734,1248.5,1493.7734,1244.5,1489.7734" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1242.5" x2="1424.5" y1="1489.7734" y2="1489.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1254.5" y="1484.7075">Consume Household Data</text><polygon fill="#454645" points="1248.5,1514.9063,1238.5,1518.9063,1248.5,1522.9063,1244.5,1518.9063" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1242.5" x2="1559" y1="1518.9063" y2="1518.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1254.5" y="1513.8403">Consume Household Data</text><polygon fill="#454645" points="1786.5,1544.0391,1796.5,1548.0391,1786.5,1552.0391,1790.5,1548.0391" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1570" x2="1792.5" y1="1548.0391" y2="1548.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1577" y="1542.9731">Store Household Data</text><polygon fill="#454645" points="1930,1603.1719,1940,1607.1719,1930,1611.1719,1934,1607.1719" style="stroke:#454645;stroke-width:1.0;"/><line style="stroke:#454645;stroke-width:1.0;" x1="1435.5" x2="1936" y1="1607.1719" y2="1607.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1442.5" y="1602.106">Persist Household Data</text><!--MD5=[f1ba668ccabe458b541abe3cb551fe84]
@startuml
title Household - Create
!theme vibrant
participant Client as c
participant HouseholdRegistry as s
participant IndividualRegistry as s2
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_create
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record already exists
    alt record found in cache
      s -> rc: Check using clientReferenceId/serverGeneratedId
      activate rc
      rc -> s: 1 row
      deactivate rc
      s -> c: HttpStatus: 400 with appropriate error code
      note left
          Error Code: RECORD_ALREADY_EXISTS
      end note
    end
    s -> rc: Check using clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Check if record already exists
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: Put data in cache using clientReferenceId/serverGeneratedId
    activate rc
    deactivate rc
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: RECORD_ALREADY_EXISTS
    end note
end
'alt individual(s) don't exist [loop on all individualId(s) in request]
'    s -> s2: /individual/v1/_search
'    activate s2
'    s2 -> s: 0 rows
'    deactivate s2
'    s -> k: Household Data /error_topic
'    note left
'        This will be marked as recoverable and will be
'        retried later
'    end note
'    activate k
'    group async
'        es -> k: Consume Household Data
'        activate es
'        deactivate k
'        es -> db: Persist Household Data /error_table
'        activate db
'        deactivate db
'        deactivate es
'    end
'    s -> c: HttpStatus: 400 with appropriate error code
'    note left
'        Error Code: DEPENDENCY_ERROR
'    end note
'end
's -> s2: /individual/v1/_search
'activate s2
's2 -> s: 1 row
'deactivate s2
's -> db: Get Individual/Household mapping using individual clientReferenceId/serverGeneratedId [loop on all individualId(s) in request]]
'activate db
'alt mapping record found
'  db -> s: 1 row
'  deactivate db
'  s -> c: HttpStatus: 400 with appropriate error code
'  note left
'      Error Code: BAD_REQUEST
'      Ensures that the individual is not already linked to a household
'  end note
'end
alt id generation fails
    s -> idgen: /id/_generate
    activate idgen
    idgen -> s: HttpStatus: 400
    deactivate idgen
    s -> k: Household Data /error_topic
    note left
        This will be marked as recoverable and 
        will be retried later
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 500 with appropriate error code
    note left
      Error Code: ID_GENERATION_FAILED
    end note
end
s -> idgen: Generate ID
activate idgen
idgen -> s: Generated ID
deactivate idgen
s -> s: Update generated ID in Household Data
s -> k: Household Data /persist_topic
activate k
s -> rc: Put Household Data against clientReferenceId/serverGeneratedId in cache
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Persist Household Data
    activate db
    deactivate db
    deactivate prs
end
deactivate k
@enduml

@startuml
title Household - Create
skinparam BackgroundColor FFFFFF
skinparam shadowing false
skinparam RoundCorner 7
skinparam ArrowColor 454645
skinparam FontColor 454645
skinparam SequenceLifeLineBorderColor 696969
skinparam SequenceGroupHeaderFontColor 454645
skinparam SequenceGroupFontColor 696969
skinparam SequenceGroupBorderColor 696969
skinparam SequenceGroupBorderThickness 1

skinparam sequenceDivider {
    BorderColor 454645
    BorderThickness 1
    FontColor 454645
}

skinparam participant {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFFFFF
    BorderThickness 1.5
}

skinparam database {
    BackgroundColor 00FFFF
    BorderColor 454645
    FontColor 454645
}

skinparam entity {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam note {
    BackgroundColor 7FFFD4
    BorderColor 454645
    FontColor 454645
    BorderThickness 1.5
}

skinparam actor {
    BackgroundColor 454645
    BorderColor 454645
    FontColor 454645
}

skinparam boundary {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam control {
    BackgroundColor FFE552
    BorderColor 454645
    FontColor 454645
}

skinparam collections {
    BackgroundColor FF5F42
    BorderColor 454645
    FontColor 454645
}

skinparam queue {
    BackgroundColor FF6347
    BorderColor 454645
    FontColor FFF
    BorderThickness 1.5
}
participant Client as c
participant HouseholdRegistry as s
participant IndividualRegistry as s2
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /household/v1/_create
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Household Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record already exists
    alt record found in cache
      s -> rc: Check using clientReferenceId/serverGeneratedId
      activate rc
      rc -> s: 1 row
      deactivate rc
      s -> c: HttpStatus: 400 with appropriate error code
      note left
          Error Code: RECORD_ALREADY_EXISTS
      end note
    end
    s -> rc: Check using clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Check if record already exists
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: Put data in cache using clientReferenceId/serverGeneratedId
    activate rc
    deactivate rc
    s -> c: HttpStatus: 400 with appropriate error code
    note left
        Error Code: RECORD_ALREADY_EXISTS
    end note
end
alt id generation fails
    s -> idgen: /id/_generate
    activate idgen
    idgen -> s: HttpStatus: 400
    deactivate idgen
    s -> k: Household Data /error_topic
    note left
        This will be marked as recoverable and 
        will be retried later
    end note
    activate k
    group async
        es -> k: Consume Household Data
        activate es
        deactivate k
        es -> db: Persist Household Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 500 with appropriate error code
    note left
      Error Code: ID_GENERATION_FAILED
    end note
end
s -> idgen: Generate ID
activate idgen
idgen -> s: Generated ID
deactivate idgen
s -> s: Update generated ID in Household Data
s -> k: Household Data /persist_topic
activate k
s -> rc: Put Household Data against clientReferenceId/serverGeneratedId in cache
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Household Data
    activate prs
    idx -> k: Consume Household Data
    activate idx
    idx -> el: Store Household Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Persist Household Data
    activate db
    deactivate db
    deactivate prs
end
deactivate k
@enduml

PlantUML version 1.2022.12(Sun Oct 23 23:42:26 IST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>